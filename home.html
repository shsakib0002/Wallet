<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#009688">
    <title>ProWallet BD | Secure Offline Finance</title>
    <meta name="description" content="Offline-first Personal Finance Manager for Bangladesh">

    <style>
        /* =========================================
           1. CSS VARIABLES & RESET
           ========================================= */
        :root {
            --primary: #009688; /* Teal */
            --primary-dark: #00796B;
            --primary-light: #B2DFDB;
            --accent: #FFC107;
            --bg-body: #F4F7F6;
            --bg-card: #FFFFFF;
            --text-main: #263238;
            --text-light: #546E7A;
            --danger: #E53935;
            --success: #43A047;
            --border: #ECEFF1;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --radius: 12px;
            --nav-width: 260px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           2. LAYOUT & RESPONSIVE
           ========================================= */
        #app { display: flex; height: 100%; width: 100%; position: relative; }

        /* Sidebar (Desktop) */
        aside {
            width: var(--nav-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: none; /* Hidden on mobile */
            flex-direction: column;
            padding: 20px;
            z-index: 50;
        }

        /* Main Content */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* Space for mobile nav */
            position: relative;
        }

        /* Mobile Bottom Nav */
        .mobile-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding: 12px 0;
            z-index: 50;
        }

        @media (min-width: 769px) {
            aside { display: flex; }
            main { padding-bottom: 20px; }
            .mobile-nav { display: none; }
            #fab { right: 40px; bottom: 40px; }
        }

        /* =========================================
           3. COMPONENTS
           ========================================= */
        /* Typography */
        h1, h2, h3 { font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; }
        .text-sm { font-size: 0.85rem; color: var(--text-light); }
        .text-lg { font-size: 1.5rem; font-weight: 700; }
        .currency { font-family: 'Courier New', monospace; letter-spacing: -0.5px; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        /* Buttons & Inputs */
        button {
            cursor: pointer; border: none; font-size: 14px;
            border-radius: 8px; padding: 12px 20px; transition: 0.2s;
            font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { border: 1px solid #ddd; background: transparent; color: var(--text-main); }
        .btn-icon { background: transparent; padding: 8px; font-size: 1.2rem; color: var(--text-light); }

        input, select {
            width: 100%; padding: 14px; border: 1px solid #ddd;
            border-radius: 8px; font-size: 16px; background: #fff;
            margin-bottom: 15px; appearance: none;
        }
        input:focus, select:focus { border-color: var(--primary); }

        /* Navigation Items */
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 14px; border-radius: 8px; color: var(--text-light);
            cursor: pointer; margin-bottom: 5px; font-weight: 500;
        }
        .nav-item:hover { background: var(--bg-body); color: var(--primary); }
        .nav-item.active { background: var(--primary-light); color: var(--primary-dark); }

        /* Fab */
        #fab {
            position: fixed; bottom: 90px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 20px rgba(0, 150, 136, 0.4);
            font-size: 30px; cursor: pointer; z-index: 40;
            transition: transform 0.2s;
        }
        #fab:hover { transform: scale(1.05); }

        /* Transaction Item */
        .tx-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid #eee;
        }
        .tx-icon {
            width: 42px; height: 42px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-right: 15px; flex-shrink: 0;
            background: var(--bg-body);
        }
        .tx-info { flex: 1; }
        .tx-amount { font-weight: 700; font-size: 16px; }
        .inc { color: var(--success); }
        .exp { color: var(--text-main); }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center; z-index: 100;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: white; width: 90%; max-width: 500px;
            border-radius: 16px; padding: 25px;
            max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Auth Screen */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 200; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }
        .pin-dots { display: flex; gap: 15px; margin: 20px 0; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; background: #ddd; transition: 0.2s; }
        .pin-dot.filled { background: var(--primary); transform: scale(1.2); }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px; }
        .num-btn { background: #f5f5f5; padding: 20px; font-size: 1.2rem; border-radius: 50%; width: 60px; height: 60px; margin: 0 auto; }
        .num-btn:active { background: #e0e0e0; }

        /* Analytics Bars */
        .bar-container { margin-bottom: 15px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .bar-track { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); border-radius: 5px; transition: width 1s ease; }

        /* Toast */
        #toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: #323232; color: white; padding: 12px 24px;
            border-radius: 24px; font-size: 14px; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 200;
        }
        #toast.show { opacity: 1; }

        /* =========================================
           4. PRINT STYLES (A4)
           ========================================= */
        @media print {
            aside, .mobile-nav, #fab, #toast, .no-print { display: none !important; }
            body, #app, main { height: auto; overflow: visible; background: white; }
            main { padding: 0; }
            .card { box-shadow: none; border: none; padding: 0; margin: 0; }
            
            /* Print Header */
            .print-header {
                display: block !important;
                border-bottom: 2px solid #333;
                margin-bottom: 20px;
                padding-bottom: 10px;
                text-align: center;
            }
            .print-table {
                width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px;
            }
            .print-table th, .print-table td {
                border: 1px solid #ddd; padding: 8px; text-align: left;
            }
            .print-table th { background: #f2f2f2; }
            .text-right { text-align: right; }
        }
        .print-header { display: none; }

    </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
    <div style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;">üîí</div>
    <h2 id="auth-title">Setup Security PIN</h2>
    <p id="auth-desc" class="text-sm">Create a 4-digit PIN to secure your wallet.</p>
    
    <div class="pin-dots">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    
    <div class="numpad">
        <button class="num-btn" onclick="Auth.input(1)">1</button>
        <button class="num-btn" onclick="Auth.input(2)">2</button>
        <button class="num-btn" onclick="Auth.input(3)">3</button>
        <button class="num-btn" onclick="Auth.input(4)">4</button>
        <button class="num-btn" onclick="Auth.input(5)">5</button>
        <button class="num-btn" onclick="Auth.input(6)">6</button>
        <button class="num-btn" onclick="Auth.input(7)">7</button>
        <button class="num-btn" onclick="Auth.input(8)">8</button>
        <button class="num-btn" onclick="Auth.input(9)">9</button>
        <button class="num-btn" style="visibility:hidden"></button>
        <button class="num-btn" onclick="Auth.input(0)">0</button>
        <button class="num-btn" onclick="Auth.clear()">‚å´</button>
    </div>
</div>

<!-- APP CONTAINER (Hidden until unlocked) -->
<div id="app" style="display:none;">
    
    <!-- SIDEBAR -->
    <aside>
        <h2 style="color: var(--primary); margin-bottom: 40px;">ProWallet BD</h2>
        <div class="nav-item active" onclick="Router.go('dashboard')">
            <span>üìä</span> Dashboard
        </div>
        <div class="nav-item" onclick="Router.go('transactions')">
            <span>üí≥</span> Transactions
        </div>
        <div class="nav-item" onclick="Router.go('analytics')">
            <span>üìà</span> Analytics
        </div>
        <div class="nav-item" onclick="Router.go('accounts')">
            <span>üè¶</span> Accounts
        </div>
        <div class="nav-item" onclick="Router.go('settings')">
            <span>‚öôÔ∏è</span> Settings
        </div>
        <div style="margin-top: auto; font-size: 12px; color: #999;">
            v1.0.0 | Offline Mode
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-container">
        <!-- Print Header (Only visible on Print) -->
        <div class="print-header">
            <h2>Financial Report</h2>
            <p id="print-date-range"></p>
        </div>

        <!-- Dynamic Content injected here -->
    </main>

    <!-- FAB -->
    <div id="fab" onclick="Views.openAddModal()">+</div>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
        <div class="nav-item" onclick="Router.go('dashboard')">üìä</div>
        <div class="nav-item" onclick="Router.go('transactions')">üí≥</div>
        <div class="nav-item" onclick="Router.go('analytics')">üìà</div>
        <div class="nav-item" onclick="Router.go('settings')">‚öôÔ∏è</div>
    </nav>

    <!-- TOAST -->
    <div id="toast">Saved Successfully</div>

    <!-- MODALS -->

    <!-- Add Transaction Modal -->
    <div id="modal-txn" class="modal-overlay">
        <div class="modal">
            <h3>Add Transaction</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-outline" style="flex:1" id="btn-exp" onclick="Views.setTxType('expense')">Expense</button>
                <button class="btn-outline" style="flex:1" id="btn-inc" onclick="Views.setTxType('income')">Income</button>
            </div>
            <form onsubmit="Actions.addTransaction(event)">
                <label class="text-sm">Amount (‡ß≥)</label>
                <input type="number" id="inp-amt" step="0.01" required placeholder="0.00">
                
                <label class="text-sm">Date</label>
                <input type="date" id="inp-date" required>

                <label class="text-sm">Category</label>
                <select id="inp-cat" onchange="Views.updateSubCats()"></select>

                <label class="text-sm">Sub-category</label>
                <select id="inp-sub"></select>

                <label class="text-sm">Account</label>
                <select id="inp-acc"></select>

                <label class="text-sm">Note</label>
                <input type="text" id="inp-note" placeholder="Details...">

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button type="button" class="btn-outline" style="flex:1" onclick="Views.closeModals()">Cancel</button>
                    <button type="submit" class="btn-primary" style="flex:1">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings/Export Modal -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal">
            <h3>Settings & Data</h3>
            <div style="display:grid; gap:15px;">
                <button class="btn-outline" onclick="Actions.exportJSON()">‚¨áÔ∏è Backup Data (JSON)</button>
                <button class="btn-outline" onclick="Actions.exportPrint()">üñ®Ô∏è Print / PDF Report</button>
                <button class="btn-danger" onclick="Actions.resetData()">‚ö†Ô∏è Reset All Data</button>
                <button class="btn-outline" onclick="Auth.logout()">üîí Lock App</button>
                <button class="btn-outline" onclick="Views.closeModals()">Close</button>
            </div>
        </div>
    </div>

</div>

<script>
/**
 * ProWallet BD - Core Application Logic
 * Architecture: State-Driven | LocalStorage | Offline
 */

const CATEGORIES = {
    "Transportation (Bangladesh)": ["Bus", "Train", "CNG / Auto Rickshaw", "Rickshaw", "Private Car", "Microbus", "Motorcycle", "Bicycle", "Launch / Ferry", "Ride Share (Uber / Pathao / Bolt)"],
    "Food": ["Fruits & Vegetables", "Meat & Fish", "Cooking", "Sauces & Pickles", "Dairy & Eggs", "Breakfast", "Snacks", "Beverages", "Frozen & Canned", "Diabetic Food", "Ice Cream"],
    "Cleaning Supplies": ["Dishwashing", "Laundry", "Toilet Cleaners", "Floor & Glass", "Air Fresheners", "Trash Bags", "Shoe Care"],
    "Home & Kitchen": ["Kitchen Accessories", "Appliances", "Tools & Hardware", "Lights & Electrical", "Gardening", "Organizer"],
    "Baby Care": ["Diapers", "Baby Food", "Skincare", "Oral Care", "Newborn Essentials"],
    "Personal Care": ["Men's Care", "Women's Care", "Handwash", "Oral Care", "Skin Care", "Hair Products"],
    "Stationery & Office": ["Writing", "Printing", "Paper Supplies", "Office Electronics", "School Supplies"],
    "Pet Care": ["Cat Food", "Dog Food", "Grooming", "Accessories"],
    "Health & Wellness": ["Medicines", "Supplements", "Medical Devices", "Antiseptics", "Masks & Safety"],
    "Vehicle Essentials": ["Fuel", "Service", "Insurance", "Parking", "Toll", "Spare Parts"]
};

const DB_KEY = "wallet_app_v1";

// Global State
let State = {
    accounts: [],
    transactions: [],
    preferences: { currency: "‡ß≥", pinHash: null, theme: "light" },
    _unsavedChanges: false
};

// ================= UTILS =================
const Utils = {
    formatMoney: (num) => new Intl.NumberFormat('en-BD', { style: 'currency', currency: 'BDT' }).format(num),
    uid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    save: () => {
        localStorage.setItem(DB_KEY, JSON.stringify(State));
    },
    load: () => {
        const data = localStorage.getItem(DB_KEY);
        if (data) State = { ...State, ...JSON.parse(data) };
        else {
            // Default Data
            State.accounts = [
                { id: 'def1', name: 'Cash Wallet', type: 'Cash', balance: 0 },
                { id: 'def2', name: 'bKash Personal', type: 'Mobile', balance: 0 }
            ];
            State.transactions = [];
        }
    },
    hashPin: async (pin) => {
        const msgBuffer = new TextEncoder().encode(pin);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
};

// ================= SECURITY =================
const Auth = {
    inputBuffer: '',
    
    check: async () => {
        if (State.preferences.pinHash) {
            // Lock Mode
            document.getElementById('auth-title').innerText = "Enter PIN to Unlock";
            document.getElementById('auth-desc').innerText = "Secure Access";
        } else {
            // Setup Mode
            document.getElementById('auth-title').innerText = "Setup New PIN";
            document.getElementById('auth-desc').innerText = "Create a 4-digit PIN for protection";
        }
    },

    input: (num) => {
        if (Auth.inputBuffer.length < 4) {
            Auth.inputBuffer += num;
            Auth.updateDots();
        }
        if (Auth.inputBuffer.length === 4) Auth.process();
    },

    clear: () => {
        Auth.inputBuffer = '';
        Auth.updateDots();
    },

    updateDots: () => {
        const dots = document.querySelectorAll('.pin-dot');
        dots.forEach((d, i) => {
            if (i < Auth.inputBuffer.length) d.classList.add('filled');
            else d.classList.remove('filled');
        });
    },

    process: async () => {
        const hash = await Utils.hashPin(Auth.inputBuffer);
        
        if (!State.preferences.pinHash) {
            // Set PIN
            State.preferences.pinHash = hash;
            Utils.save();
            Auth.unlock();
        } else {
            // Verify PIN
            if (hash === State.preferences.pinHash) {
                Auth.unlock();
            } else {
                document.getElementById('auth-title').innerText = "Incorrect PIN";
                document.getElementById('auth-title').style.color = "var(--danger)";
                setTimeout(() => {
                    Auth.clear();
                    document.getElementById('auth-title').innerText = "Enter PIN to Unlock";
                    document.getElementById('auth-title').style.color = "var(--text-main)";
                }, 1000);
            }
        }
    },

    unlock: () => {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        Router.init();
    },

    logout: () => {
        location.reload(); // Simple reload to lock
    }
};

// ================= ACTIONS =================
const Actions = {
    addTransaction: (e) => {
        e.preventDefault();
        const type = document.getElementById('btn-exp').classList.contains('active') ? 'expense' : 'income';
        const amt = parseFloat(document.getElementById('inp-amt').value);
        const accId = document.getElementById('inp-acc').value;
        const date = document.getElementById('inp-date').value;
        const cat = document.getElementById('inp-cat').value;
        const sub = document.getElementById('inp-sub').value;
        const note = document.getElementById('inp-note').value;

        // Update Account Balance
        const accIndex = State.accounts.findIndex(a => a.id === accId);
        if (accIndex > -1) {
            if (type === 'expense') State.accounts[accIndex].balance -= amt;
            else State.accounts[accIndex].balance += amt;
        }

        // Save Transaction
        State.transactions.unshift({
            id: Utils.uid(),
            date, type, amount: amt, category: cat, subcategory: sub, accountId: accId, note
        });

        Utils.save();
        Views.closeModals();
        Router.refresh();
    },

    addAccount: () => {
        const name = prompt("Account Name (e.g., Bank Asia):");
        if (!name) return;
        State.accounts.push({ id: Utils.uid(), name, type: 'Bank', balance: 0 });
        Utils.save();
        Router.refresh();
    },

    deleteTx: (id) => {
        if(!confirm("Delete this record?")) return;
        const tx = State.transactions.find(t => t.id === id);
        
        // Refund Balance
        const accIndex = State.accounts.findIndex(a => a.id === tx.accountId);
        if (accIndex > -1) {
            if (tx.type === 'expense') State.accounts[accIndex].balance += tx.amount;
            else State.accounts[accIndex].balance -= tx.amount;
        }

        State.transactions = State.transactions.filter(t => t.id !== id);
        Utils.save();
        Router.refresh();
    },

    resetData: () => {
        if(confirm("DANGER: This will WIPE ALL DATA. Are you sure?")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    },

    exportJSON: () => {
        const str = JSON.stringify(State);
        const blob = new Blob([str], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    },

    exportPrint: () => {
        // Render Print View then trigger print
        Views.closeModals();
        Views.renderPrintView();
        setTimeout(() => window.print(), 500);
    }
};

// ================= VIEWS =================
const Views = {
    currentTxType: 'expense',

    setTxType: (type) => {
        Views.currentTxType = type;
        document.getElementById('btn-exp').classList.toggle('active', type === 'expense');
        document.getElementById('btn-inc').classList.toggle('active', type === 'income');
        
        document.getElementById('btn-exp').style.background = type === 'expense' ? 'var(--primary)' : 'transparent';
        document.getElementById('btn-exp').style.color = type === 'expense' ? 'white' : 'inherit';
        
        document.getElementById('btn-inc').style.background = type === 'income' ? 'var(--success)' : 'transparent';
        document.getElementById('btn-inc').style.color = type === 'income' ? 'white' : 'inherit';
    },

    openAddModal: () => {
        // Populate Selects
        const selCat = document.getElementById('inp-cat');
        selCat.innerHTML = '<option value="">Select Category</option>';
        Object.keys(CATEGORIES).forEach(k => selCat.add(new Option(k, k)));

        const selAcc = document.getElementById('inp-acc');
        selAcc.innerHTML = '';
        State.accounts.forEach(a => selAcc.add(new Option(`${a.name} (${Utils.formatMoney(a.balance)})`, a.id)));

        document.getElementById('inp-date').valueAsDate = new Date();
        Views.setTxType('expense');
        
        document.getElementById('modal-txn').classList.add('open');
    },

    updateSubCats: () => {
        const cat = document.getElementById('inp-cat').value;
        const selSub = document.getElementById('inp-sub');
        selSub.innerHTML = '';
        if(cat && CATEGORIES[cat]) {
            CATEGORIES[cat].forEach(s => selSub.add(new Option(s, s)));
        }
    },

    closeModals: () => {
        document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('open'));
        // If we closed print view (which replaces main content), reload dashboard
        if(document.getElementById('print-header').style.display === 'block') {
            Router.go('dashboard');
        }
    },

    renderDashboard: () => {
        const total = State.accounts.reduce((sum, a) => sum + a.balance, 0);
        const recent = State.transactions.slice(0, 5);
        
        let html = `
            <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color:white;">
                <div class="text-sm">Total Balance</div>
                <div class="text-lg currency" style="margin: 10px 0;">${Utils.formatMoney(total)}</div>
                <div class="text-sm" style="opacity:0.8">Overview of all accounts</div>
            </div>

            <h3>Accounts</h3>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:25px;">
                ${State.accounts.map(a => `
                    <div class="card" style="margin:0; padding:15px;">
                        <div class="text-sm">${a.name}</div>
                        <div style="font-weight:bold; font-size:1.1rem;">${Utils.formatMoney(a.balance)}</div>
                    </div>
                `).join('')}
                <div class="card" style="margin:0; padding:15px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px dashed #ccc;" onclick="Actions.addAccount()">
                    + Add
                </div>
            </div>

            <h3>Recent Transactions</h3>
            <div class="card" style="padding:0 20px;">
                ${recent.length ? '' : '<p style="padding:20px 0; color:#999;">No transactions found.</p>'}
                ${recent.map(t => Views.txItem(t)).join('')}
            </div>
        `;
        document.getElementById('main-container').innerHTML = html;
    },

    renderTransactions: () => {
        const list = State.transactions;
        let html = `<h2>All Transactions</h2><div class="card" style="padding:0 20px;">`;
        html += list.length ? '' : '<p style="padding:20px 0; color:#999;">No records.</p>';
        html += list.map(t => Views.txItem(t)).join('');
        html += `</div>`;
        document.getElementById('main-container').innerHTML = html;
    },

    txItem: (t) => {
        const isExp = t.type === 'expense';
        const colorClass = isExp ? 'exp' : 'inc';
        const sign = isExp ? '-' : '+';
        const accName = State.accounts.find(a => a.id === t.accountId)?.name || 'Unknown';
        return `
            <div class="tx-item">
                <div style="display:flex; align-items:center;">
                    <div class="tx-icon">üí≥</div>
                    <div class="tx-info">
                        <div style="font-weight:600;">${t.category}</div>
                        <div class="text-sm">${t.subcategory} ‚Ä¢ ${t.date}</div>
                        <div class="text-sm" style="font-size:11px;">${accName}</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div class="tx-amount ${colorClass}">${sign} ${Utils.formatMoney(t.amount)}</div>
                    <button class="btn-icon" style="font-size:14px;" onclick="Actions.deleteTx('${t.id}')">üóëÔ∏è</button>
                </div>
            </div>
        `;
    },

    renderAnalytics: () => {
        // Group by category
        const cats = {};
        let totalExp = 0;
        State.transactions.filter(t => t.type === 'expense').forEach(t => {
            cats[t.category] = (cats[t.category] || 0) + t.amount;
            totalExp += t.amount;
        });

        let html = `<h2>Expense Analytics</h2><div class="card">`;
        
        if(totalExp === 0) html += `<p class="text-sm">No expense data.</p>`;
        else {
            Object.entries(cats)
                .sort((a,b) => b[1] - a[1])
                .forEach(([cat, amt]) => {
                    const pct = ((amt / totalExp) * 100).toFixed(1);
                    html += `
                        <div class="bar-container">
                            <div class="bar-label">
                                <span>${cat}</span>
                                <span>${Utils.formatMoney(amt)} (${pct}%)</span>
                            </div>
                            <div class="bar-track">
                                <div class="bar-fill" style="width:${pct}%"></div>
                            </div>
                        </div>
                    `;
                });
        }
        html += `</div>`;
        document.getElementById('main-container').innerHTML = html;
    },

    renderAccounts: () => {
        let html = `<h2>Accounts Management</h2>
            <button class="btn-primary" onclick="Actions.addAccount()" style="margin-bottom:20px;">+ New Account</button>
            <div class="card" style="padding:0;">
                <table style="width:100%; border-collapse:collapse;">
                    <tr style="background:#f9f9f9; text-align:left;">
                        <th style="padding:15px;">Name</th>
                        <th style="padding:15px;">Balance</th>
                    </tr>
                    ${State.accounts.map(a => `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:15px;">${a.name}</td>
                            <td style="padding:15px; font-weight:bold;">${Utils.formatMoney(a.balance)}</td>
                        </tr>
                    `).join('')}
                </table>
            </div>
        `;
        document.getElementById('main-container').innerHTML = html;
    },

    renderSettings: () => {
        document.getElementById('modal-settings').classList.add('open');
    },

    renderPrintView: () => {
        const date = new Date();
        document.getElementById('print-date-range').innerText = `Generated on: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        
        // Generate Table
        let rows = State.transactions.map(t => {
            const acc = State.accounts.find(a => a.id === t.accountId)?.name;
            return `
                <tr>
                    <td>${t.date}</td>
                    <td>${t.type.toUpperCase()}</td>
                    <td>${t.category}</td>
                    <td>${t.subcategory}</td>
                    <td>${acc}</td>
                    <td>${t.note}</td>
                    <td class="text-right">${t.type==='exp'?'-':''}${t.amount}</td>
                </tr>
            `;
        }).join('');

        const html = `
            <div style="padding:20px;">
                <h3 style="text-align:center; margin-top:0;">Transaction Report</h3>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Date</th><th>Type</th><th>Category</th><th>Sub</th><th>Account</th><th>Note</th><th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
                <div style="text-align:center; margin-top:30px; font-size:12px; color:#999;">
                    Generated by ProWallet BD Offline
                </div>
            </div>
        `;
        document.getElementById('main-container').innerHTML = html;
        document.getElementById('fab').style.display = 'none'; // Hide FAB for print
    }
};

// ================= ROUTER =================
const Router = {
    go: (route) => {
        // Update Nav UI
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Very simple mapping for demo
        // Highlighting logic skipped for brevity in single file, but route works
        
        if(route === 'dashboard') Views.renderDashboard();
        if(route === 'transactions') Views.renderTransactions();
        if(route === 'analytics') Views.renderAnalytics();
        if(route === 'accounts') Views.renderAccounts();
        if(route === 'settings') Views.renderSettings();
    },

    init: () => {
        Router.go('dashboard');
    },
    
    refresh: () => {
        const currentHash = window.location.hash || '#dashboard';
        Router.go(currentHash.replace('#', ''));
    }
};

// ================= INITIALIZATION =================
window.onload = async () => {
    Utils.load();
    await Auth.check();
};

</script>
</body>
</html>
